---
- name: Проверка, что мы не под root
  ansible.builtin.fail:
    msg: "Не запускайте этот playbook под пользователем root! Используйте обычного пользователя с sudo."
  when: ansible_user_id == 'root'

- name: Установка системных пакетов (pacman)
  become: true
  community.general.pacman:
    name: "{{ system_packages }}"
    state: present
    update_cache: yes

- name: Удаление старой версии starship из /usr/local/bin (если есть)
  become: true
  ansible.builtin.file:
    path: /usr/local/bin/starship
    state: absent

- name: Проверка наличия yay
  ansible.builtin.command: which yay
  register: packages_yay_check
  failed_when: false
  changed_when: false

- name: Установка yay-bin (AUR helper)
  when: packages_yay_check.rc != 0
  block:
    - name: Удаление временной папки yay-bin
      ansible.builtin.file:
        path: /tmp/yay-bin
        state: absent

    - name: Клонирование репозитория yay-bin
      ansible.builtin.git:
        repo: https://aur.archlinux.org/yay-bin.git
        dest: /tmp/yay-bin
        version: master
      become: false

    - name: Сборка yay-bin
      ansible.builtin.command: makepkg -s --noconfirm
      args:
        chdir: /tmp/yay-bin
      become: false
      changed_when: true

    - name: Установка yay-bin через pacman
      ansible.builtin.shell: pacman -U --noconfirm yay-bin-*.pkg.tar.zst
      args:
        chdir: /tmp/yay-bin
      become: true
      changed_when: true

    - name: Удаление временной папки yay-bin после установки
      ansible.builtin.file:
        path: /tmp/yay-bin
        state: absent

- name: Установка AUR пакетов
  kewlfft.aur.aur:
    name: "{{ aur_packages }}"
    use: yay
    state: present
  become: false
  when: aur_packages | length > 0
