---
- name: Полная настройка системы Arch Linux
  hosts: localhost

  pre_tasks:
    - name: Установка базовых инструментов (Bootstrap)
      become: true
      community.general.pacman:
        name:
          - fish
          - jq
          - bitwarden-cli
          - pass
          - git
          - openssh
        state: present
        update_cache: true

    - name: Смена оболочки пользователя на Fish
      become: true
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        shell: /usr/bin/fish

    - name: Извлечение секретов из Bitwarden (SSH, GPG, Pass)
      ansible.builtin.script: ../../scripts/bitwarden-extract-ssh.fish
      args:
        executable: /usr/bin/fish
      environment:
        BW_CLIENTID: "{{ bitwarden_client_id | default('') }}"
        BW_CLIENTSECRET: "{{ bitwarden_client_secret | default('') }}"
        BW_PASSWORD: "{{ bitwarden_password | default('') }}"
      # Эта задача может быть пропущена, если скрипт требует интерактивности,
      # но он критичен для дальнейшей работы (git clone через SSH).

  roles:
    - packages  # Установка софта
    - system    # Системные конфиги (SDDM, NPM)
    - user      # Пользовательские настройки (Shell, Venv, Pass)
    - dotfiles  # Симлинки конфигов
